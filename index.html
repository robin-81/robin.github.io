import React, { useMemo, useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Progress } from "@/components/ui/progress";
import { Check, RotateCcw, Share2, Copy, Link as LinkIcon } from "lucide-react";

/**
 * å¿«çœ ã‚´ãƒªãƒ©å¿ƒç†ã‚¯ã‚¤ã‚º - å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«Reactã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 * ä½¿ã„æ–¹ï¼šã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’1ãƒšãƒ¼ã‚¸ã¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆVite/Next/CRAã„ãšã‚Œã§ã‚‚OKï¼‰ã€‚
 * å…±æœ‰ï¼šå›ç­”å¾Œã«ã€Œçµæœãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã€ã§URLã‚’é…å¸ƒã™ã‚Œã°ã€åŒã˜çµæœãŒé–‹ã‘ã¾ã™ã€‚
 * ä¼ç”»ï¼šé£²ã¿ä¼šã§å…¨å“¡ãŒåŒã˜ãƒªãƒ³ã‚¯ã‚’é–‹ãã€é€²è¡Œå½¹ãŒèª­ã¿ä¸Šã’ã€‚å„è‡ªãŒã‚¿ãƒƒãƒ—ã§å›ç­”â†’çµæœãŒå‡ºã¾ã™ã€‚
 */

const QUESTIONS = [
  {
    id: "q1",
    title: "ç†æƒ³ã®â€œçœ ã‚Šã®æ£®â€ã‚’ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚ã©ã‚“ãªå ´æ‰€ã§çœ ã‚ŠãŸã„ï¼Ÿ",
    choices: [
      { key: "A", label: "æœ¨ã€…ã®é–“ã‚’æŠœã‘ã‚‹æ¶¼ã—ã„é¢¨ãŒå¿ƒåœ°ã‚ˆã„æ£®" },
      { key: "B", label: "å°å·ã®ã›ã›ã‚‰ããŒé™ã‹ã«éŸ¿ãæ£®" },
      { key: "C", label: "ã‚„ã‚ã‚‰ã‹ãªç„šãç«ã®ãã°ã§å®‰å¿ƒã§ãã‚‹æ£®" },
    ],
  },
  {
    id: "q2",
    title: "å¸ƒå›£ã«å…¥ã£ãŸã¨ãã€ã¤ã„è€ƒãˆã¦ã—ã¾ã†ã“ã¨ã¯ï¼Ÿ",
    choices: [
      { key: "A", label: "ä»Šæ—¥ã‚‚ã‚ˆãæ­©ã„ãŸãªâ€¦è¶³ã®é‡ã•ãŒæ°—ã«ãªã‚‹" },
      { key: "B", label: "æ˜æ—¥ã‚‚å…ƒæ°—ã§ã„ãŸã„ãªâ€¦ä½“èª¿ã‚’æ•´ãˆãŸã„" },
      { key: "C", label: "ã‚„ã£ã±ã‚Šå¿ƒã‚’è½ã¡ç€ã‘ã¦çœ ã‚ŠãŸã„" },
    ],
  },
  {
    id: "q3",
    title: "ç†æƒ³ã®çœ ã‚Šã«è¿‘ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ï¼Ÿ",
    choices: [
      { key: "A", label: "è„šãŒã™ã£ã¨è»½ããªã£ã¦æ·±ãçœ ã‚Œã‚‹" },
      { key: "B", label: "ã˜ã‚“ã‚ã‚Šãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦è‡ªç„¶ã¨çœ ã‚Šã«è½ã¡ã‚‹" },
      { key: "C", label: "å®‰å¿ƒæ„Ÿã«åŒ…ã¾ã‚Œã¦å¿ƒåœ°ã‚ˆãçœ ã‚Œã‚‹" },
    ],
  },
] as const;

const PRODUCTS = {
  A: {
    code: "hitotsukami",
    name: "ã‚´ãƒªãƒ©ã®ã²ã¨ã¤ã‹ã¿ï¼ˆãµãã‚‰ã¯ãã‚±ã‚¢ï¼‰",
    tagline: "è„šãŒè»½ããªã‚‹ã¨ã€çœ ã‚Šã¯æ·±ããªã‚‹ã€‚",
    type: "ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¿«çœ ã‚¿ã‚¤ãƒ—",
  },
  B: {
    code: "hitotsuki",
    name: "ã‚´ãƒªãƒ©ã®ã²ã¨ã¤ãï¼ˆè¶³ã†ã‚‰ã‚±ã‚¢ï¼‰",
    tagline: "ãƒ„ãƒœã‚’ã˜ã‚“ã‚ã‚Šã€è‡ªç„¶ã«ã¨ã‚ã‘ã‚‹å…¥çœ ã«ã€‚",
    type: "ãƒªãƒ©ãƒƒã‚¯ã‚¹å¿«çœ ã‚¿ã‚¤ãƒ—",
  },
  C: {
    code: "akushu",
    name: "ã‚´ãƒªãƒ©ã®æ¡æ‰‹ï¼ˆæ‰‹ã‚±ã‚¢ï¼‰",
    tagline: "ã¬ãã‚‚ã‚Šã®å®‰å¿ƒæ„Ÿã§ã€ã™ã£ã¨å¤¢ã®ä¸­ã¸ã€‚",
    type: "å®‰å¿ƒå¿«çœ ã‚¿ã‚¤ãƒ—",
  },
} as const;

type Key = keyof typeof PRODUCTS; // "A" | "B" | "C"

function chooseResult(answers: Record<string, Key>): Key {
  const counts: Record<Key, number> = { A: 0, B: 0, C: 0 };
  Object.values(answers).forEach((k) => (counts[k] += 1));
  const max = Math.max(counts.A, counts.B, counts.C);
  const candidates = (Object.keys(counts) as Key[]).filter((k) => counts[k] === max);
  // åŒæ•°ã®å ´åˆã¯Q1â†’Q2â†’Q3ã®å„ªå…ˆé †ã§æ±ºã‚ã‚‹
  if (candidates.length > 1) {
    for (const q of QUESTIONS) {
      const k = answers[q.id];
      if (candidates.includes(k)) return k;
    }
  }
  return candidates[0];
}

function enc(answers: Record<string, Key>) {
  const s = QUESTIONS.map((q) => answers[q.id] ?? "").join("");
  return s;
}
function dec(s: string): Record<string, Key> {
  const out: Record<string, Key> = {} as any;
  QUESTIONS.forEach((q, i) => {
    const ch = (s || "")[i] as Key | undefined;
    if (ch && ["A", "B", "C"].includes(ch)) out[q.id] = ch;
  });
  return out;
}

export default function SleepGorillaQuiz() {
  const urlParams = new URLSearchParams(typeof window !== "undefined" ? window.location.search : "");
  const preset = urlParams.get("answers") || urlParams.get("a") || "";
  const [answers, setAnswers] = useState<Record<string, Key>>(() => dec(preset));
  const [step, setStep] = useState<number>(() => {
    const filled = Object.keys(answers).length;
    return Math.min(filled, QUESTIONS.length);
  });

  const progress = (step / QUESTIONS.length) * 100;
  const finished = step >= QUESTIONS.length;
  const resultKey = useMemo(() => (finished ? chooseResult(answers) : undefined), [finished, answers]);
  const result = resultKey ? PRODUCTS[resultKey] : undefined;

  useEffect(() => {
    // URLã«å›ç­”çŸ­ç¸®ã‚³ãƒ¼ãƒ‰ã‚’åæ˜ ï¼ˆä»–ã®äººã¨åŒã˜çµæœã‚’å…±æœ‰ã§ãã‚‹ï¼‰
    const code = enc(answers);
    const params = new URLSearchParams(window.location.search);
    if (code) {
      params.set("a", code);
    } else {
      params.delete("a");
    }
    const newUrl = `${window.location.pathname}?${params.toString()}`;
    window.history.replaceState({}, "", newUrl);
  }, [answers]);

  const handleSelect = (qId: string, key: Key) => {
    setAnswers((prev) => ({ ...prev, [qId]: key }));
    setStep((s) => Math.min(s + 1, QUESTIONS.length));
  };

  const reset = () => {
    setAnswers({});
    setStep(0);
  };

  const copyLink = async () => {
    const link = window.location.href;
    try {
      await navigator.clipboard.writeText(link);
      alert("ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
    } catch (e) {
      prompt("ã‚³ãƒ”ãƒ¼ã§ããªã„å ´åˆã¯æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„", link);
    }
  };

  return (
    <div className="min-h-screen bg-pink-50 text-gray-900 flex items-center justify-center p-4">
      <div className="w-full max-w-3xl">
        <header className="mb-6 text-center">
          <h1 className="text-3xl md:text-4xl font-bold tracking-tight">å¿«çœ ã‚´ãƒªãƒ©å¿ƒç†ã‚¯ã‚¤ã‚º</h1>
          <p className="text-gray-600 mt-2">é£²ã¿ä¼šã§éŠã¹ã‚‹3å•è¨ºæ–­ã€‚ãƒªãƒ³ã‚¯ã‚’é…ã£ã¦å„è‡ªã‚¹ãƒãƒ›ã§å›ç­”ï¼</p>
        </header>

        <Card className="shadow-xl rounded-2xl">
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <span className="text-xl">{finished ? "çµæœ" : `Q${step + 1} / ${QUESTIONS.length}`}</span>
            </CardTitle>
            {!finished && <Progress value={progress} className="h-2" />}
          </CardHeader>

          <CardContent className="space-y-6">
            {!finished ? (
              <Question
                q={QUESTIONS[step]}
                onSelect={handleSelect}
              />
            ) : (
              <ResultView key={resultKey} resultKey={resultKey!} result={result!} onReset={reset} onCopy={copyLink} />
            )}

            <div className="flex flex-wrap items-center justify-between gap-3 pt-2 border-t">
              <div className="text-sm text-gray-500 flex items-center gap-2">
                <LinkIcon className="w-4 h-4" />
                <span>ã“ã®ãƒšãƒ¼ã‚¸ã‚’å…¨å“¡ã«é…ã£ã¦åŒæ™‚ã«å›ç­”OK</span>
              </div>
              <div className="flex items-center gap-2">
                <Button variant="outline" size="sm" onClick={copyLink}><Copy className="w-4 h-4 mr-1"/>çµæœãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</Button>
                <Button variant="ghost" size="sm" onClick={reset}><RotateCcw className="w-4 h-4 mr-1"/>ã‚„ã‚Šç›´ã™</Button>
              </div>
            </div>
          </CardContent>
        </Card>

        <footer className="mt-6 text-center text-xs text-gray-500">
          <p>â€»ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã¯ã€Œä¸€ç•ªå¤šãé¸ã‚“ã ç­”ãˆã€ã§æ±ºå®šï¼ˆåŒæ•°æ™‚ã¯Q1â†’Q2â†’Q3ã®é †ã§å„ªå…ˆï¼‰ã€‚</p>
        </footer>
      </div>
    </div>
  );
}

function Question({ q, onSelect }: { q: typeof QUESTIONS[number]; onSelect: (id: string, key: Key) => void }) {
  return (
    <div className="space-y-5">
      <h2 className="text-2xl font-semibold leading-snug">{q.title}</h2>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
        {q.choices.map((c) => (
          <button
            key={c.key}
            onClick={() => onSelect(q.id, c.key as Key)}
            className="text-left rounded-2xl border bg-white hover:bg-pink-100 transition p-4 shadow-sm"
          >
            <div className="text-sm text-gray-500 font-mono mb-1">{c.key}</div>
            <div className="font-medium">{c.label}</div>
          </button>
        ))}
      </div>
    </div>
  );
}

function ResultView({ resultKey, result, onReset, onCopy }: { resultKey: Key; result: (typeof PRODUCTS)[Key]; onReset: () => void; onCopy: () => void }) {
  const productUrl = "https://e-doshisha.com/hanako/index.html"; // å…¬å¼ãƒšãƒ¼ã‚¸ï¼ˆã‚·ãƒªãƒ¼ã‚ºä¸€è¦§ï¼‰
  return (
    <div className="space-y-4">
      <div className="text-center space-y-2">
        <div className="inline-block text-5xl">ğŸ¦âœ¨</div>
        <h2 className="text-2xl md:text-3xl font-bold">ã‚ãªãŸã¯ã€Œ{result.type}ã€</h2>
        <p className="text-gray-600">ãŠã™ã™ã‚ï¼š<span className="font-semibold">{result.name}</span></p>
        <p className="text-gray-500">{result.tagline}</p>
      </div>
      <div className="flex flex-wrap gap-3 justify-center">
        <a href={productUrl} target="_blank" rel="noreferrer" className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-black text-white hover:opacity-90">
          <Check className="w-4 h-4" />
          å•†å“ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹
        </a>
        <Button variant="outline" onClick={onCopy}><Share2 className="w-4 h-4 mr-1"/>çµæœãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼</Button>
        <Button variant="ghost" onClick={onReset}><RotateCcw className="w-4 h-4 mr-1"/>æœ€åˆã‹ã‚‰</Button>
      </div>
      <div className="text-xs text-gray-500 text-center">
        URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€Œ?a=ABCã€ã§çµæœã‚’å†ç¾ã§ãã¾ã™ï¼ˆä¾‹ï¼šA=Q1ã€B=Q2ã€C=Q3ï¼‰ã€‚
      </div>
    </div>
  );
}


